<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV ç¹ªåœ–èˆ‡ Python è½‰å‡ºå·¥å…·</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root { --primary: #4f46e5; --secondary: #10b981; --danger: #ef4444; --bg: #f3f4f6; --card: #ffffff; --border: #e5e7eb; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: var(--bg); color: #1f2937; }
        
        .layout { display: grid; grid-template-columns: 380px 1fr; gap: 20px; align-items: start; }
        
        .sidebar { display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        
        h2 { font-size: 1.1rem; margin-top: 0; margin-bottom: 15px; color: #374151; border-bottom: 2px solid var(--primary); padding-bottom: 8px; display: inline-block; }
        
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; color: #4b5563; }
        input[type="text"], input[type="file"], select { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; font-size: 0.9rem; margin-bottom: 10px; transition: border 0.2s; }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        
        .global-settings { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full-width { grid-column: 1 / -1; }

        .layer-list { display: flex; flex-direction: column; gap: 10px; max-height: 500px; overflow-y: auto; padding-right: 5px; }
        .layer-card { background: #f9fafb; border: 1px solid #e5e7eb; border-left: 4px solid var(--primary); padding: 15px; border-radius: 6px; position: relative; }
        
        .layer-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .layer-title { font-weight: bold; font-size: 0.9rem; color: var(--primary); }
        .btn-remove { background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 1.2rem; line-height: 1; padding: 0; }
        .btn-remove:hover { color: var(--danger); }

        .layer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .btn-group { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;}
        button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; flex: 1; min-width: 120px;}
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: white; border: 1px solid #d1d5db; color: #374151; }
        .btn-secondary:hover { background-color: #f3f4f6; }
        .btn-python { background-color: var(--secondary); color: white; }
        .btn-python:hover { background-color: #059669; }
        
        #file-status { margin-top: 5px; font-size: 0.85rem; color: #059669; }
        .plot-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: sticky; top: 20px; }
        #plot-area { width: 100%; height: 700px; }

        @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="layout">
    <div class="sidebar">
        
        <!-- 1. è³‡æ–™ä¸Šå‚³ -->
        <div class="card">
            <h2>ğŸ“‚ 1. è³‡æ–™ä¾†æº</h2>
            <label>ä¸Šå‚³ CSV æª”æ¡ˆ (å¯å¤šé¸)</label>
            <input type="file" id="csv-files" accept=".csv" multiple>
            <div id="file-status">å°šæœªè¼‰å…¥æª”æ¡ˆ</div>
        </div>

        <!-- 2. å…¨å±€è¨­å®š -->
        <div class="card">
            <h2>âš™ï¸ 2. åœ–è¡¨è¨­å®š</h2>
            <div class="global-settings">
                <div class="full-width">
                    <label>åœ–è¡¨ä¸»æ¨™é¡Œ</label>
                    <input type="text" id="chart-title" placeholder="ä¾‹å¦‚ï¼šå¹´åº¦éŠ·å”®è¶¨å‹¢åœ–">
                </div>
                <div>
                    <label>X è»¸åç¨±</label>
                    <input type="text" id="xaxis-title" placeholder="ä¾‹å¦‚ï¼šæ—¥æœŸ">
                </div>
                <div>
                    <label>Y è»¸åç¨±</label>
                    <input type="text" id="yaxis-title" placeholder="ä¾‹å¦‚ï¼šé‡‘é¡">
                </div>
            </div>
        </div>

        <!-- 3. åœ–å±¤ç®¡ç† -->
        <div class="card">
            <div class="layer-header">
                <h2>ğŸ“š 3. åœ–å±¤ç®¡ç†</h2>
                <span id="layer-count" style="font-size: 0.8rem; color: #6b7280; padding-top: 5px;">0 å€‹åœ–å±¤</span>
            </div>
            
            <div id="layer-container" class="layer-list">
                <div style="text-align: center; color: #9ca3af; padding: 20px; font-style: italic;" id="empty-msg">
                    è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢åœ–å±¤
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-secondary" onclick="addNewLayer()">+ æ–°å¢åœ–å±¤</button>
            </div>
            <div class="btn-group">
                <button class="btn-primary" onclick="drawChart()">ğŸš€ ç¶²é ç¹ªåœ–</button>
                <button class="btn-python" onclick="downloadPythonCode()">ğŸ ä¸‹è¼‰ Python</button>
            </div>
        </div>
    </div>

    <div class="plot-container">
        <div id="plot-area"></div>
    </div>
</div>

<script>
    const filesData = {}; 
    let layerCounter = 0; 

    // 1. æª”æ¡ˆä¸Šå‚³
    document.getElementById('csv-files').addEventListener('change', function(e) {
        const files = e.target.files;
        if (!files.length) return;

        const statusDiv = document.getElementById('file-status');
        statusDiv.innerHTML = `â³ è®€å–ä¸­...`;
        
        let loadedCount = 0;
        Array.from(files).forEach(file => {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    filesData[file.name] = {
                        data: results.data,
                        headers: results.meta.fields
                    };
                    loadedCount++;
                    if(loadedCount === files.length) {
                        statusDiv.innerHTML = `âœ… å·²è¼‰å…¥ ${Object.keys(filesData).length} å€‹æª”æ¡ˆ`;
                        refreshAllFileSelects();
                    }
                }
            });
        });
    });

    // 2. åœ–å±¤æ“ä½œ
    function addNewLayer() {
        document.getElementById('empty-msg').style.display = 'none';
        layerCounter++;
        const container = document.getElementById('layer-container');
        const layerId = `layer-${layerCounter}`;
        
        const div = document.createElement('div');
        div.className = 'layer-card';
        div.id = layerId;
        div.innerHTML = `
            <div class="layer-header">
                <span class="layer-title">åœ–å±¤ #${layerCounter}</span>
                <button class="btn-remove" onclick="removeLayer('${layerId}')">Ã—</button>
            </div>
            <div class="full-width">
                <label>ä¾†æºæª”æ¡ˆ</label>
                <select class="file-select" onchange="updateLayerColumns('${layerId}')"><option value="">è«‹é¸æ“‡æª”æ¡ˆ...</option></select>
            </div>
            <div class="layer-grid">
                <div><label>X è»¸</label><select class="x-select"><option>-</option></select></div>
                <div><label>Y è»¸</label><select class="y-select"><option>-</option></select></div>
                <div><label>é¡å‹</label>
                    <select class="type-select">
                        <option value="line">æŠ˜ç·šåœ–</option>
                        <option value="scatter">æ•£ä½ˆåœ–</option>
                        <option value="bar">é•·æ¢åœ–</option>
                    </select>
                </div>
                <div><label>åœ–ä¾‹åç¨±</label><input type="text" class="name-input" placeholder="è‡ªè¨‚åç¨±"></div>
            </div>
        `;
        container.appendChild(div);
        populateFileOptions(div.querySelector('.file-select'));
        updateLayerCount();
    }

    function removeLayer(id) {
        document.getElementById(id).remove();
        updateLayerCount();
        if(document.querySelectorAll('.layer-card').length === 0) document.getElementById('empty-msg').style.display = 'block';
    }

    function updateLayerCount() {
        document.getElementById('layer-count').innerText = `${document.querySelectorAll('.layer-card').length} å€‹åœ–å±¤`;
    }

    // 3. é¸å–®é‚è¼¯
    function populateFileOptions(selectElement) {
        const currentVal = selectElement.value;
        selectElement.innerHTML = '<option value="">è«‹é¸æ“‡æª”æ¡ˆ...</option>';
        Object.keys(filesData).forEach(fname => selectElement.add(new Option(fname, fname)));
        if (Object.keys(filesData).includes(currentVal)) selectElement.value = currentVal;
    }

    function refreshAllFileSelects() {
        document.querySelectorAll('.file-select').forEach(s => populateFileOptions(s));
    }

    function updateLayerColumns(layerId) {
        const card = document.getElementById(layerId);
        const fileName = card.querySelector('.file-select').value;
        const xSelect = card.querySelector('.x-select');
        const ySelect = card.querySelector('.y-select');
        xSelect.innerHTML = ''; ySelect.innerHTML = '';

        if (!fileName || !filesData[fileName]) return;

        filesData[fileName].headers.forEach(h => {
            xSelect.add(new Option(h, h));
            ySelect.add(new Option(h, h));
        });
        if(filesData[fileName].headers.length > 1) ySelect.selectedIndex = 1;
    }

    // 4. ç¶²é ç¹ªåœ– (Plotly)
    function drawChart() {
        const layers = document.querySelectorAll('.layer-card');
        const traces = [];
        
        layers.forEach(card => {
            const fileName = card.querySelector('.file-select').value;
            const xCol = card.querySelector('.x-select').value;
            const yCol = card.querySelector('.y-select').value;
            const type = card.querySelector('.type-select').value;
            const name = card.querySelector('.name-input').value;

            if (!fileName || !filesData[fileName]) return;
            const data = filesData[fileName].data.filter(d => d[xCol] != null && d[yCol] != null);
            if (type !== 'bar') data.sort((a, b) => (a[xCol] > b[xCol] ? 1 : -1));

            traces.push({
                x: data.map(d => d[xCol]),
                y: data.map(d => d[yCol]),
                name: name || `${yCol} (${fileName})`,
                type: type === 'bar' ? 'bar' : 'scatter',
                mode: type === 'line' ? 'lines+markers' : (type === 'scatter' ? 'markers' : undefined)
            });
        });

        const layout = {
            title: document.getElementById('chart-title').value,
            xaxis: { title: document.getElementById('xaxis-title').value, automargin: true },
            yaxis: { title: document.getElementById('yaxis-title').value, automargin: true },
            margin: { t: 50, l: 60, r: 40, b: 80 },
            legend: { orientation: 'h', y: -0.2 },
            hovermode: 'closest'
        };
        Plotly.newPlot('plot-area', traces, layout, { responsive: true });
    }

    // 5. Python ç¨‹å¼ç¢¼ç”Ÿæˆèˆ‡ä¸‹è¼‰ (æ ¸å¿ƒæ–°å¢åŠŸèƒ½)
    function downloadPythonCode() {
        const layers = document.querySelectorAll('.layer-card');
        if (layers.length === 0) {
            alert('è«‹å…ˆæ–°å¢åœ–å±¤ä¸¦è¨­å®šè³‡æ–™');
            return;
        }

        const chartTitle = document.getElementById('chart-title').value || "Plot Title";
        const xAxisTitle = document.getElementById('xaxis-title').value || "X Axis";
        const yAxisTitle = document.getElementById('yaxis-title').value || "Y Axis";

        let pythonCode = `
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import os
import platform

# --- è‡ªå‹•è¨­å®šä¸­æ–‡å­—å‹ (é¿å…äº‚ç¢¼) ---
def set_chinese_font():
    system = platform.system()
    font_path = None
    
    if system == 'Windows':
        font_path = 'C:/Windows/Fonts/msjh.ttc' # å¾®è»Ÿæ­£é»‘é«”
    elif system == 'Darwin': # macOS
        font_path = '/System/Library/Fonts/PingFang.ttc' # è˜‹æ–¹
    
    if font_path and os.path.exists(font_path):
        prop = fm.FontProperties(fname=font_path)
        plt.rcParams['font.family'] = prop.get_name()
    else:
        # å‚™ç”¨ï¼šå˜—è©¦æœå°‹å¸¸è¦‹ä¸­æ–‡å­—å‹
        plt.rcParams['font.sans-serif'] = ['Microsoft JhengHei', 'SimHei', 'Arial Unicode MS']

    plt.rcParams['axes.unicode_minus'] = False # è§£æ±ºè² è™Ÿé¡¯ç¤ºå•é¡Œ

set_chinese_font()

# --- ç¹ªåœ–è¨­å®š ---
plt.figure(figsize=(10, 6))
`;

        layers.forEach((card, index) => {
            const fileName = card.querySelector('.file-select').value;
            const xCol = card.querySelector('.x-select').value;
            const yCol = card.querySelector('.y-select').value;
            const type = card.querySelector('.type-select').value;
            let name = card.querySelector('.name-input').value;
            
            if (!fileName) return;
            if (!name) name = `${yCol} (${fileName})`;

            // Python code for this layer
            pythonCode += `
# Layer ${index + 1}: ${fileName}
try:
    df_${index} = pd.read_csv('${fileName}')
    # ç°¡å–®æ’åº (é©ç”¨æ–¼æŠ˜ç·šåœ–)
    if '${type}' != 'bar':
        df_${index} = df_${index}.sort_values(by='${xCol}')
    
    x = df_${index}['${xCol}']
    y = df_${index}['${yCol}']
    
    if '${type}' == 'bar':
        plt.bar(x, y, label='${name}', alpha=0.7)
    elif '${type}' == 'scatter':
        plt.scatter(x, y, label='${name}')
    else: # line
        plt.plot(x, y, marker='o', label='${name}')

except FileNotFoundError:
    print(f"éŒ¯èª¤: æ‰¾ä¸åˆ°æª”æ¡ˆ '${fileName}'ï¼Œè«‹ç¢ºä¿ csv æª”èˆ‡æ­¤è…³æœ¬åœ¨åŒä¸€ç›®éŒ„ä¸‹ã€‚")
except KeyError:
    print(f"éŒ¯èª¤: åœ¨ '${fileName}' ä¸­æ‰¾ä¸åˆ°æ¬„ä½ '${xCol}' æˆ– '${yCol}'ã€‚")
`;
        });

        // çµå°¾è¨­å®š
        pythonCode += `
# --- è£é£¾èˆ‡é¡¯ç¤º ---
plt.title('${chartTitle}', fontsize=16)
plt.xlabel('${xAxisTitle}', fontsize=12)
plt.ylabel('${yAxisTitle}', fontsize=12)
plt.legend()
plt.grid(True, linestyle='--', alpha=0.6)
plt.tight_layout()

print("æ­£åœ¨é¡¯ç¤ºåœ–è¡¨...")
plt.show()
`;

        // è§¸ç™¼ä¸‹è¼‰
        const blob = new Blob([pythonCode], { type: 'text/x-python' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'plot_script.py';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    addNewLayer(); // åˆå§‹åŒ–
</script>

</body>
</html>
```

### å¦‚ä½•ä½¿ç”¨ç”Ÿæˆçš„ Python æª”æ¡ˆ

ç•¶ä½¿ç”¨è€…é»æ“Šã€Œ**ğŸ ä¸‹è¼‰ Python**ã€å¾Œï¼Œæœƒå¾—åˆ°ä¸€å€‹ `plot_script.py`ã€‚è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©ŸåŸ·è¡Œï¼š

1.  **ç’°å¢ƒæº–å‚™**ï¼š
    ç¢ºä¿é›»è…¦å·²å®‰è£ Pythonï¼Œä¸¦å®‰è£éœ€è¦çš„å¥—ä»¶ï¼š
    ```bash
    pip install pandas matplotlib
    ```

2.  **æª”æ¡ˆæ”¾ç½®**ï¼š
    å°‡ä¸‹è¼‰çš„ `plot_script.py` èˆ‡æ‚¨ä½¿ç”¨çš„ **CSV æª”æ¡ˆæ”¾åœ¨åŒä¸€å€‹è³‡æ–™å¤¾**ä¸­ã€‚

3.  **åŸ·è¡Œ**ï¼š
    åœ¨çµ‚ç«¯æ©Ÿæˆ– CMD åŸ·è¡Œï¼š
    ```bash
    python plot_script.py
