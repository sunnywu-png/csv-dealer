<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV é€²éšåœ–å±¤ç¹ªåœ–å·¥å…·</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root { --primary: #4f46e5; --danger: #ef4444; --bg: #f3f4f6; --card: #ffffff; --border: #e5e7eb; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: var(--bg); color: #1f2937; }
        
        /* ç‰ˆé¢é…ç½® */
        .layout { display: grid; grid-template-columns: 380px 1fr; gap: 20px; align-items: start; }
        
        /* å·¦å´æ§åˆ¶å€ */
        .sidebar { display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        
        h2 { font-size: 1.1rem; margin-top: 0; margin-bottom: 15px; color: #374151; border-bottom: 2px solid var(--primary); padding-bottom: 8px; display: inline-block; }
        
        /* è¼¸å…¥å…ƒä»¶æ¨£å¼ */
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; color: #4b5563; }
        input[type="text"], input[type="file"], select { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; font-size: 0.9rem; margin-bottom: 10px; transition: border 0.2s; }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        
        /* å…¨å±€è¨­å®šå€ */
        .global-settings { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full-width { grid-column: 1 / -1; }

        /* åœ–å±¤å¡ç‰‡æ¨£å¼ */
        .layer-list { display: flex; flex-direction: column; gap: 10px; max-height: 500px; overflow-y: auto; padding-right: 5px; }
        .layer-card { background: #f9fafb; border: 1px solid #e5e7eb; border-left: 4px solid var(--primary); padding: 15px; border-radius: 6px; position: relative; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .layer-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .layer-title { font-weight: bold; font-size: 0.9rem; color: var(--primary); }
        .btn-remove { background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 1.2rem; line-height: 1; padding: 0; }
        .btn-remove:hover { color: var(--danger); }

        .layer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; flex: 1; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: white; border: 1px solid #d1d5db; color: #374151; }
        .btn-secondary:hover { background-color: #f3f4f6; }
        
        /* æª”æ¡ˆç‹€æ…‹æ¨™ç±¤ */
        #file-status { margin-top: 5px; font-size: 0.85rem; color: #059669; }

        /* å³å´ç¹ªåœ–å€ */
        .plot-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: sticky; top: 20px; }
        #plot-area { width: 100%; height: 700px; }

        @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="layout">
    <div class="sidebar">
        
        <div class="card">
            <h2>ğŸ“‚ 1. è³‡æ–™ä¾†æº</h2>
            <label>ä¸Šå‚³ CSV æª”æ¡ˆ (å¯å¤šé¸)</label>
            <input type="file" id="csv-files" accept=".csv" multiple>
            <div id="file-status">å°šæœªè¼‰å…¥æª”æ¡ˆ</div>
        </div>

        <div class="card">
            <h2>âš™ï¸ 2. åœ–è¡¨è¨­å®š</h2>
            <div class="global-settings">
                <div class="full-width">
                    <label>åœ–è¡¨ä¸»æ¨™é¡Œ</label>
                    <input type="text" id="chart-title" placeholder="ä¾‹å¦‚ï¼šå¹´åº¦éŠ·å”®è¶¨å‹¢åœ–">
                </div>
                <div>
                    <label>X è»¸åç¨±</label>
                    <input type="text" id="xaxis-title" placeholder="ä¾‹å¦‚ï¼šæ—¥æœŸ">
                </div>
                <div>
                    <label>Y è»¸åç¨±</label>
                    <input type="text" id="yaxis-title" placeholder="ä¾‹å¦‚ï¼šé‡‘é¡">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="layer-header">
                <h2>ğŸ“š 3. åœ–å±¤ç®¡ç†</h2>
                <span id="layer-count" style="font-size: 0.8rem; color: #6b7280; padding-top: 5px;">0 å€‹åœ–å±¤</span>
            </div>
            
            <div id="layer-container" class="layer-list">
                <div style="text-align: center; color: #9ca3af; padding: 20px; font-style: italic;" id="empty-msg">
                    è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢åœ–å±¤
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-secondary" onclick="addNewLayer()">+ æ–°å¢ç©ºç™½åœ–å±¤</button>
                <button class="btn-primary" onclick="drawChart()">ğŸš€ ç¹ªè£½åœ–è¡¨</button>
            </div>
        </div>
    </div>

    <div class="plot-container">
        <div id="plot-area"></div>
    </div>
</div>

<script>
    // å…¨åŸŸè®Šæ•¸
    const filesData = {}; // å„²å­˜ CSV è³‡æ–™: { "filename": {header:[], data:[]} }
    let layerCounter = 0; // ç”¨æ–¼ç”¢ç”Ÿå”¯ä¸€ ID

    // 1. æª”æ¡ˆä¸Šå‚³è™•ç†
    document.getElementById('csv-files').addEventListener('change', function(e) {
        const files = e.target.files;
        if (!files.length) return;

        const statusDiv = document.getElementById('file-status');
        statusDiv.innerHTML = `â³ è®€å–ä¸­...`;
        
        let loadedCount = 0;
        Array.from(files).forEach(file => {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    filesData[file.name] = {
                        data: results.data,
                        headers: results.meta.fields
                    };
                    loadedCount++;
                    
                    if(loadedCount === files.length) {
                        statusDiv.innerHTML = `âœ… å·²è¼‰å…¥ ${Object.keys(filesData).length} å€‹æª”æ¡ˆ`;
                        // æ›´æ–°æ‰€æœ‰ç¾æœ‰åœ–å±¤çš„æª”æ¡ˆé¸å–®
                        refreshAllFileSelects();
                    }
                }
            });
        });
    });

    // 2. æ–°å¢åœ–å±¤ (UI æ“ä½œ)
    function addNewLayer() {
        document.getElementById('empty-msg').style.display = 'none';
        layerCounter++;
        
        const container = document.getElementById('layer-container');
        const layerId = `layer-${layerCounter}`;
        
        const div = document.createElement('div');
        div.className = 'layer-card';
        div.id = layerId;
        div.innerHTML = `
            <div class="layer-header">
                <span class="layer-title">åœ–å±¤ #${layerCounter}</span>
                <button class="btn-remove" onclick="removeLayer('${layerId}')" title="åˆªé™¤åœ–å±¤">Ã—</button>
            </div>
            
            <div class="full-width">
                <label>ä¾†æºæª”æ¡ˆ</label>
                <select class="file-select" onchange="updateLayerColumns('${layerId}')">
                    <option value="">è«‹é¸æ“‡æª”æ¡ˆ...</option>
                </select>
            </div>
            
            <div class="layer-grid">
                <div>
                    <label>X è»¸æ¬„ä½</label>
                    <select class="x-select"><option>-</option></select>
                </div>
                <div>
                    <label>Y è»¸æ¬„ä½</label>
                    <select class="y-select"><option>-</option></select>
                </div>
                <div>
                    <label>åœ–è¡¨é¡å‹</label>
                    <select class="type-select">
                        <option value="scatter">æŠ˜ç·šåœ–</option>
                        <option value="bar">é•·æ¢åœ–</option>
                        <option value="markers">æ•£ä½ˆåœ–</option>
                    </select>
                </div>
                <div>
                    <label>åœ–ä¾‹åç¨±</label>
                    <input type="text" class="name-input" placeholder="è‡ªè¨‚åç¨±">
                </div>
            </div>
        `;
        
        container.appendChild(div);
        
        // å¡«å……å‰›å‰›æ–°å¢çš„ select
        const fileSelect = div.querySelector('.file-select');
        populateFileOptions(fileSelect);
        updateLayerCount();
    }

    // 3. åˆªé™¤åœ–å±¤
    function removeLayer(id) {
        document.getElementById(id).remove();
        updateLayerCount();
        if(document.querySelectorAll('.layer-card').length === 0) {
            document.getElementById('empty-msg').style.display = 'block';
        }
    }

    function updateLayerCount() {
        const count = document.querySelectorAll('.layer-card').length;
        document.getElementById('layer-count').innerText = `${count} å€‹åœ–å±¤`;
    }

    // 4. ä¸‹æ‹‰é¸å–®é‚è¼¯
    
    // å¡«å……å–®ä¸€é¸å–®çš„æª”æ¡ˆé¸é …
    function populateFileOptions(selectElement) {
        const currentVal = selectElement.value; // ä¿ç•™åŸæœ¬é¸çš„å€¼
        selectElement.innerHTML = '<option value="">è«‹é¸æ“‡æª”æ¡ˆ...</option>';
        Object.keys(filesData).forEach(fname => {
            selectElement.add(new Option(fname, fname));
        });
        if (Object.keys(filesData).includes(currentVal)) {
            selectElement.value = currentVal;
        }
    }

    // ç•¶æœ‰æ–°æª”æ¡ˆä¸Šå‚³æ™‚ï¼Œåˆ·æ–°æ‰€æœ‰åœ–å±¤çš„æª”æ¡ˆé¸å–®
    function refreshAllFileSelects() {
        document.querySelectorAll('.file-select').forEach(select => {
            populateFileOptions(select);
        });
    }

    // ç•¶é¸æ“‡æª”æ¡ˆæ”¹è®Šæ™‚ï¼Œæ›´æ–°è©²åœ–å±¤çš„ X/Y é¸é …
    function updateLayerColumns(layerId) {
        const card = document.getElementById(layerId);
        const fileName = card.querySelector('.file-select').value;
        const xSelect = card.querySelector('.x-select');
        const ySelect = card.querySelector('.y-select');

        xSelect.innerHTML = '';
        ySelect.innerHTML = '';

        if (!fileName || !filesData[fileName]) {
            xSelect.add(new Option('-', ''));
            ySelect.add(new Option('-', ''));
            return;
        }

        const headers = filesData[fileName].headers;
        headers.forEach(h => {
            xSelect.add(new Option(h, h));
            ySelect.add(new Option(h, h));
        });

        // æ™ºæ…§é é¸ Y è»¸ (é¸ç¬¬äºŒå€‹)
        if(headers.length > 1) ySelect.selectedIndex = 1;
    }

    // 5. ç¹ªåœ–ä¸»é‚è¼¯
    function drawChart() {
        const layers = document.querySelectorAll('.layer-card');
        const traces = [];
        
        // æ”¶é›†æ‰€æœ‰åœ–å±¤è¨­å®š
        layers.forEach(card => {
            const fileName = card.querySelector('.file-select').value;
            const xCol = card.querySelector('.x-select').value;
            const yCol = card.querySelector('.y-select').value;
            const type = card.querySelector('.type-select').value;
            const nameInput = card.querySelector('.name-input').value;

            if (!fileName || !filesData[fileName]) return; // è·³éæœªè¨­å®šçš„

            const rawData = filesData[fileName].data;
            
            // è³‡æ–™æ¸…æ´—èˆ‡æ•´ç†
            let plotData = rawData.map(row => ({
                x: row[xCol],
                y: row[yCol]
            })).filter(d => d.x != null && d.y != null);

            // æ’åº (é‡å°æŠ˜ç·šåœ–)
            if (type !== 'bar') { // Bar chart æœ‰æ™‚ä¸éœ€è¦è‡ªå‹•æ’åºï¼Œè¦–éœ€æ±‚è€Œå®š
                plotData.sort((a, b) => (a.x > b.x ? 1 : -1));
            }

            // å»ºç«‹ Trace
            const trace = {
                x: plotData.map(d => d.x),
                y: plotData.map(d => d.y),
                name: nameInput || `${yCol} (${fileName})`, // è‹¥æ²’å¡«åç¨±ï¼Œç”¨é è¨­
                type: type === 'bar' ? 'bar' : 'scatter',
                mode: type === 'markers' ? 'markers' : (type === 'bar' ? undefined : 'lines+markers')
            };
            traces.push(trace);
        });

        // è®€å–å…¨å±€è¨­å®š
        const chartTitle = document.getElementById('chart-title').value || 'æ•¸æ“šåœ–è¡¨';
        const xAxisTitle = document.getElementById('xaxis-title').value;
        const yAxisTitle = document.getElementById('yaxis-title').value;

        const layout = {
            title: { text: chartTitle, font: { size: 24 } },
            xaxis: { title: { text: xAxisTitle }, automargin: true },
            yaxis: { title: { text: yAxisTitle }, automargin: true },
            margin: { t: 60, l: 60, r: 40, b: 80 },
            legend: { orientation: 'h', y: -0.2 }, // åœ–ä¾‹æ”¾ä¸‹é¢
            hovermode: 'closest'
        };

        const config = { responsive: true };

        Plotly.newPlot('plot-area', traces, layout, config);
    }
    
    // åˆå§‹åŒ–æ™‚ç”¢ç”Ÿä¸€å€‹ç©ºç™½åœ–å±¤
    addNewLayer();
</script>

</body>
</html>
