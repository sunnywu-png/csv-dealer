<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV ç¹ªåœ–èˆ‡è¨Šè™Ÿåˆ†æå·¥å…·</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root { --primary: #4f46e5; --secondary: #10b981; --info: #0ea5e9; --danger: #ef4444; --bg: #f3f4f6; --card: #ffffff; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: var(--bg); color: #1f2937; }
        
        .layout { display: grid; grid-template-columns: 380px 1fr; gap: 20px; align-items: start; }
        .sidebar { display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        
        h2 { font-size: 1.1rem; margin-top: 0; margin-bottom: 15px; color: #374151; border-bottom: 2px solid var(--primary); padding-bottom: 8px; }
        
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; color: #4b5563; }
        input[type="text"], input[type="file"], select { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; font-size: 0.9rem; margin-bottom: 10px; }
        
        .global-settings { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full-width { grid-column: 1 / -1; }

        .layer-list { display: flex; flex-direction: column; gap: 10px; max-height: 500px; overflow-y: auto; padding-right: 5px; }
        .layer-card { background: #f9fafb; border: 1px solid #e5e7eb; border-left: 4px solid var(--primary); padding: 15px; border-radius: 6px; position: relative; }
        
        .layer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .layer-title { font-weight: bold; font-size: 0.9rem; color: var(--primary); }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-icon { background: none; border: none; cursor: pointer; padding: 4px; border-radius: 4px; transition: 0.2s; }
        .btn-remove { color: #9ca3af; font-size: 1.2rem; }
        .btn-remove:hover { color: var(--danger); background: #fee2e2; }
        .btn-analyze { color: var(--info); font-size: 1.1rem; margin-right: 5px; }
        .btn-analyze:hover { color: #0284c7; background: #e0f2fe; }

        .layer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .btn-group { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;}
        button.action-btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; flex: 1; min-width: 120px;}
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: white; border: 1px solid #d1d5db; color: #374151; }
        .btn-secondary:hover { background-color: #f3f4f6; }
        .btn-python { background-color: var(--secondary); color: white; }
        .btn-python:hover { background-color: #059669; }

        .plot-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: sticky; top: 20px; }
        #plot-area { width: 100%; height: 700px; }

        /* Modal (å½ˆå‡ºè¦–çª—) æ¨£å¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popin 0.3s ease; }
        @keyframes popin { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h3 { margin: 0; color: #1f2937; }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: #000; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { background: #f8fafb; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; }
        .stat-value { display: block; font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 5px 0; }
        .stat-label { font-size: 0.9rem; color: #64748b; }
        .stat-sub { font-size: 0.8rem; color: #94a3b8; margin-top: 5px; }

        @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="layout">
    <div class="sidebar">
        <!-- 1. è³‡æ–™ä¸Šå‚³ -->
        <div class="card">
            <h2>ğŸ“‚ 1. è³‡æ–™ä¾†æº</h2>
            <label>ä¸Šå‚³ CSV æª”æ¡ˆ (å¯å¤šé¸)</label>
            <input type="file" id="csv-files" accept=".csv" multiple>
            <div id="file-status" style="margin-top:5px; color:#059669; font-size:0.85rem;">å°šæœªè¼‰å…¥æª”æ¡ˆ</div>
        </div>

        <!-- 2. å…¨å±€è¨­å®š -->
        <div class="card">
            <h2>âš™ï¸ 2. åœ–è¡¨è¨­å®š</h2>
            <div class="global-settings">
                <div class="full-width"><label>åœ–è¡¨æ¨™é¡Œ</label><input type="text" id="chart-title" placeholder="ä¾‹å¦‚ï¼šéœ‡å‹•æ¸¬è©¦çµæœ"></div>
                <div><label>X è»¸åç¨±</label><input type="text" id="xaxis-title" placeholder="Time (s)"></div>
                <div><label>Y è»¸åç¨±</label><input type="text" id="yaxis-title" placeholder="Amplitude"></div>
            </div>
        </div>

        <!-- 3. åœ–å±¤ç®¡ç† -->
        <div class="card">
            <div class="layer-header">
                <h2>ğŸ“š 3. åœ–å±¤ç®¡ç†</h2>
                <span id="layer-count" style="font-size: 0.8rem; color: #6b7280;">0 å€‹åœ–å±¤</span>
            </div>
            
            <div id="layer-container" class="layer-list">
                <div style="text-align: center; color: #9ca3af; padding: 20px;" id="empty-msg">è«‹æ–°å¢åœ–å±¤</div>
            </div>

            <div class="btn-group">
                <button class="action-btn btn-secondary" onclick="addNewLayer()">+ æ–°å¢åœ–å±¤</button>
            </div>
            <div class="btn-group">
                <button class="action-btn btn-primary" onclick="drawChart()">ğŸš€ ç¶²é ç¹ªåœ–</button>
            </div>
            <div class="btn-group">
                <button class="action-btn btn-python" onclick="downloadPythonCode()">ğŸ ä¸‹è¼‰ Python</button>
            </div>
        </div>
    </div>

    <div class="plot-container">
        <div id="plot-area"></div>
    </div>
</div>

<!-- åˆ†æçµæœ Modal -->
<div id="analysis-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">è¨Šè™Ÿåˆ†æçµæœ</h3>
            <span class="close-modal" onclick="closeModal()">&times;</span>
        </div>
        <div id="modal-body">
            <!-- å‹•æ…‹å¡«å……å…§å®¹ -->
        </div>
    </div>
</div>

<script>
    const filesData = {}; 
    let layerCounter = 0; 

    // 1. æª”æ¡ˆä¸Šå‚³
    document.getElementById('csv-files').addEventListener('change', function(e) {
        const files = e.target.files;
        if (!files.length) return;
        const statusDiv = document.getElementById('file-status');
        statusDiv.innerHTML = `â³ è®€å–ä¸­...`;
        
        let loadedCount = 0;
        Array.from(files).forEach(file => {
            Papa.parse(file, {
                header: true, dynamicTyping: true, skipEmptyLines: true,
                complete: function(results) {
                    filesData[file.name] = { data: results.data, headers: results.meta.fields };
                    loadedCount++;
                    if(loadedCount === files.length) {
                        statusDiv.innerHTML = `âœ… å·²è¼‰å…¥ ${Object.keys(filesData).length} å€‹æª”æ¡ˆ`;
                        refreshAllFileSelects();
                    }
                }
            });
        });
    });

    // 2. åœ–å±¤æ“ä½œ
    function addNewLayer() {
        document.getElementById('empty-msg').style.display = 'none';
        layerCounter++;
        const layerId = `layer-${layerCounter}`;
        const div = document.createElement('div');
        div.className = 'layer-card';
        div.id = layerId;
        div.innerHTML = `
            <div class="layer-header">
                <span class="layer-title">åœ–å±¤ #${layerCounter}</span>
                <div>
                    <button class="btn-icon btn-analyze" onclick="analyzeLayer('${layerId}')" title="åˆ†ææŒ¯å¹…èˆ‡é »ç‡">ğŸ” æª¢è¦–</button>
                    <button class="btn-icon btn-remove" onclick="removeLayer('${layerId}')" title="ç§»é™¤">Ã—</button>
                </div>
            </div>
            <div class="full-width">
                <label>ä¾†æºæª”æ¡ˆ</label>
                <select class="file-select" onchange="updateLayerColumns('${layerId}')"><option value="">è«‹é¸æ“‡æª”æ¡ˆ...</option></select>
            </div>
            <div class="layer-grid">
                <div><label>X è»¸</label><select class="x-select"><option>-</option></select></div>
                <div><label>Y è»¸</label><select class="y-select"><option>-</option></select></div>
                <div><label>é¡å‹</label>
                    <select class="type-select">
                        <option value="line">æŠ˜ç·šåœ–</option>
                        <option value="scatter">æ•£ä½ˆåœ–</option>
                        <option value="bar">é•·æ¢åœ–</option>
                    </select>
                </div>
                <div><label>åœ–ä¾‹åç¨±</label><input type="text" class="name-input" placeholder="è‡ªè¨‚åç¨±"></div>
            </div>
        `;
        document.getElementById('layer-container').appendChild(div);
        populateFileOptions(div.querySelector('.file-select'));
        updateLayerCount();
    }

    function removeLayer(id) {
        document.getElementById(id).remove();
        updateLayerCount();
        if(document.querySelectorAll('.layer-card').length === 0) document.getElementById('empty-msg').style.display = 'block';
    }

    function updateLayerCount() {
        document.getElementById('layer-count').innerText = `${document.querySelectorAll('.layer-card').length} å€‹åœ–å±¤`;
    }

    function populateFileOptions(selectElement) {
        const currentVal = selectElement.value;
        selectElement.innerHTML = '<option value="">è«‹é¸æ“‡æª”æ¡ˆ...</option>';
        Object.keys(filesData).forEach(fname => selectElement.add(new Option(fname, fname)));
        if (Object.keys(filesData).includes(currentVal)) selectElement.value = currentVal;
    }

    function refreshAllFileSelects() { document.querySelectorAll('.file-select').forEach(s => populateFileOptions(s)); }

    function updateLayerColumns(layerId) {
        const card = document.getElementById(layerId);
        const fileName = card.querySelector('.file-select').value;
        const xSelect = card.querySelector('.x-select');
        const ySelect = card.querySelector('.y-select');
        xSelect.innerHTML = ''; ySelect.innerHTML = '';
        if (!fileName || !filesData[fileName]) return;
        filesData[fileName].headers.forEach(h => { xSelect.add(new Option(h, h)); ySelect.add(new Option(h, h)); });
        if(filesData[fileName].headers.length > 1) ySelect.selectedIndex = 1;
    }

    // 3. æ ¸å¿ƒåŠŸèƒ½ï¼šè¨Šè™Ÿåˆ†æ (Amplitude & Frequency)
    function analyzeLayer(layerId) {
        const card = document.getElementById(layerId);
        const fileName = card.querySelector('.file-select').value;
        const xCol = card.querySelector('.x-select').value;
        const yCol = card.querySelector('.y-select').value;

        if (!fileName || !filesData[fileName] || !xCol || !yCol) {
            alert("è«‹å…ˆå®Œæ•´è¨­å®šæª”æ¡ˆèˆ‡ X/Y è»¸");
            return;
        }

        const rawData = filesData[fileName].data.filter(d => d[xCol] != null && d[yCol] != null);
        
        // å˜—è©¦è½‰æ› X è»¸ç‚ºæ•¸å­— (è™•ç†æ™‚é–“)
        const data = rawData.map(d => {
            let xVal = d[xCol];
            // å¦‚æœæ˜¯å­—ä¸²æ ¼å¼çš„æ™‚é–“ï¼Œå˜—è©¦è½‰ç‚º timestamp
            if (typeof xVal === 'string' && !isNaN(Date.parse(xVal))) {
                xVal = Date.parse(xVal) / 1000; // è½‰ç‚ºç§’
            }
            return { x: Number(xVal), y: Number(d[yCol]) };
        }).sort((a, b) => a.x - b.x);

        if (data.length < 2) { alert("æ•¸æ“šé»å¤ªå°‘ï¼Œç„¡æ³•åˆ†æ"); return; }

        // --- è¨ˆç®—çµ±è¨ˆå€¼ ---
        const yValues = data.map(d => d.y);
        const max = Math.max(...yValues);
        const min = Math.min(...yValues);
        const mean = yValues.reduce((a, b) => a + b, 0) / yValues.length;
        
        // 1. æŒ¯å¹…è¨ˆç®—
        const peakToPeak = max - min;
        const amplitude = peakToPeak / 2;

        // 2. é »ç‡è¨ˆç®— (éé›¶ç‡ Zero-Crossing ä¼°ç®—)
        let frequency = 0;
        let period = 0;
        let validFreq = false;

        // æª¢æŸ¥ X è»¸æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­—ï¼Œæ‰èƒ½ç®—é »ç‡
        if (!isNaN(data[1].x - data[0].x)) {
            let crossings = 0;
            for (let i = 1; i < data.length; i++) {
                // æª¢æŸ¥æ˜¯å¦ç©¿éå¹³å‡ç·š (ç°¡å–®ç‰ˆï¼Œä¸å«é²æ»¯)
                if ((data[i].y > mean && data[i-1].y <= mean) || (data[i].y < mean && data[i-1].y >= mean)) {
                    crossings++;
                }
            }
            // é »ç‡ = (ç©¿è¶Šæ¬¡æ•¸ / 2) / ç¸½æ™‚é–“
            const duration = data[data.length - 1].x - data[0].x;
            if (duration > 0 && crossings > 0) {
                // ç©¿è¶Šå…©æ¬¡ç®—ä¸€å€‹å®Œæ•´é€±æœŸ
                frequency = (crossings / 2) / duration;
                period = 1 / frequency;
                validFreq = true;
            }
        }

        // --- é¡¯ç¤º Modal ---
        const modalBody = document.getElementById('modal-body');
        document.getElementById('modal-title').innerText = `åˆ†æï¼š${yCol} (${fileName})`;
        
        modalBody.innerHTML = `
            <div class="stat-grid">
                <div class="stat-item">
                    <span class="stat-label">æŒ¯å¹… (Amplitude)</span>
                    <span class="stat-value">${amplitude.toFixed(4)}</span>
                    <span class="stat-sub">(Max - Min) / 2</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ä¸»é »ç‡ (Frequency)</span>
                    <span class="stat-value">${validFreq ? frequency.toFixed(4) + ' Hz' : 'N/A'}</span>
                    <span class="stat-sub">${validFreq ? `é€±æœŸ: ${period.toFixed(4)} s` : 'Xè»¸éæ•¸å€¼æˆ–ç„¡é€±æœŸ'}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æœ€å¤§å€¼ (Max)</span>
                    <span class="stat-value" style="color:#ef4444">${max.toFixed(4)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æœ€å°å€¼ (Min)</span>
                    <span class="stat-value" style="color:#10b981">${min.toFixed(4)}</span>
                </div>
                <div class="stat-item full-width" style="grid-column: 1 / -1;">
                    <span class="stat-label">å³°å°å³°å€¼ (Peak-to-Peak)</span>
                    <span class="stat-value" style="color:#333">${peakToPeak.toFixed(4)}</span>
                </div>
            </div>
            <p style="font-size:0.8rem; color:#888; margin-top:15px; text-align:center;">
                * é »ç‡ä¼°ç®—æ¡ç”¨ã€Œéé›¶ç‡ã€æ³•ï¼Œåƒ…ä¾›åƒè€ƒã€‚è‹¥è¨Šè™Ÿéé€±æœŸæ€§æˆ–é›œè¨Šéå¤§å¯èƒ½ä¸æº–ç¢ºã€‚
            </p>
        `;
        
        document.getElementById('analysis-modal').style.display = "block";
    }

    // Modal æ§åˆ¶
    function closeModal() { document.getElementById('analysis-modal').style.display = "none"; }
    window.onclick = function(event) {
        if (event.target == document.getElementById('analysis-modal')) closeModal();
    }

    // 4. ç¹ªåœ–èˆ‡ä¸‹è¼‰ (ä¿æŒåŸæœ‰åŠŸèƒ½)
    function drawChart() {
        const layers = document.querySelectorAll('.layer-card');
        const traces = [];
        layers.forEach(card => {
            const fileName = card.querySelector('.file-select').value;
            const xCol = card.querySelector('.x-select').value;
            const yCol = card.querySelector('.y-select').value;
            const type = card.querySelector('.type-select').value;
            const name = card.querySelector('.name-input').value;
            if (!fileName || !filesData[fileName]) return;
            const data = filesData[fileName].data.filter(d => d[xCol] != null && d[yCol] != null);
            if (type !== 'bar') data.sort((a, b) => (a[xCol] > b[xCol] ? 1 : -1));
            traces.push({
                x: data.map(d => d[xCol]), y: data.map(d => d[yCol]),
                name: name || `${yCol} (${fileName})`,
                type: type === 'bar' ? 'bar' : 'scatter',
                mode: type === 'line' ? 'lines+markers' : (type === 'scatter' ? 'markers' : undefined)
            });
        });
        Plotly.newPlot('plot-area', traces, {
            title: document.getElementById('chart-title').value,
            xaxis: { title: document.getElementById('xaxis-title').value, automargin: true },
            yaxis: { title: document.getElementById('yaxis-title').value, automargin: true },
            margin: { t: 50, l: 60, r: 40, b: 80 }, legend: { orientation: 'h', y: -0.2 }
        }, { responsive: true });
    }

    function downloadPythonCode() {
        // ç°¡æ˜“ç‰ˆ Python ä¸‹è¼‰é‚è¼¯ (ç‚ºç¯€çœé•·åº¦ï¼Œä¿ç•™èˆ‡ä¸Šç‰ˆç›¸åŒåŠŸèƒ½)
        const chartTitle = document.getElementById('chart-title').value || "Plot";
        let pythonCode = `import pandas as pd\nimport matplotlib.pyplot as plt\nplt.rcParams['font.sans-serif'] = ['Microsoft JhengHei', 'Arial Unicode MS']\nplt.rcParams['axes.unicode_minus'] = False\nplt.figure(figsize=(10, 6))\n`;
        document.querySelectorAll('.layer-card').forEach((card, i) => {
            const f = card.querySelector('.file-select').value;
            const x = card.querySelector('.x-select').value;
            const y = card.querySelector('.y-select').value;
            const t = card.querySelector('.type-select').value;
            if(f) pythonCode += `try:\n    df = pd.read_csv('${f}')\n    if '${t}'!='bar': df=df.sort_values('${x}')\n    plt.plot(df['${x}'], df['${y}'], label='${y}', marker='o' if '${t}'=='line' else '')\nexcept: pass\n`;
        });
        pythonCode += `plt.title('${chartTitle}')\nplt.legend()\nplt.grid(True)\nplt.show()`;
        const blob = new Blob([pythonCode], {type: 'text/x-python'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'plot.py'; a.click();
    }

    addNewLayer();
</script>

</body>
</html>

