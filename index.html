<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€²éš CSV ç¹ªåœ–å·¥å…·</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background-color: #f0f2f5; color: #333; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        
        .control-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; margin-bottom: 20px; }
        
        .input-group { display: flex; flex-direction: column; }
        label { font-weight: 600; font-size: 0.9em; margin-bottom: 8px; color: #555; }
        
        select, input[type="file"] { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; background-color: #fff; font-size: 14px; }
        select:focus, input:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        
        .action-area { text-align: center; margin-top: 10px; }
        button { 
            background-color: #007bff; color: white; border: none; padding: 12px 30px; 
            font-size: 16px; font-weight: bold; border-radius: 6px; cursor: pointer; transition: all 0.2s; 
            box-shadow: 0 2px 5px rgba(0,123,255,0.3);
        }
        button:hover { background-color: #0056b3; transform: translateY(-1px); }
        button:active { transform: translateY(1px); }
        
        #plot-area { width: 100%; height: 600px; border: 1px solid #eee; border-radius: 8px; margin-top: 20px; background: #fff; }
        .hidden { display: none; }
        .full-width { grid-column: 1 / -1; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“Š CSV é€²éšç¹ªåœ–å·¥å…·</h1>
    
    <div class="control-panel">
        <div class="input-group full-width">
            <label for="csv-file">ğŸ“‚ æ­¥é©Ÿ 1ï¼šä¸Šå‚³ CSV æª”æ¡ˆ</label>
            <input type="file" id="csv-file" accept=".csv">
        </div>

        <div id="column-selectors" class="hidden contents" style="display: contents;">
            <div class="input-group">
                <label for="x-axis">æ­¥é©Ÿ 2ï¼šé¸æ“‡ X è»¸ (æ©«è»¸)</label>
                <select id="x-axis"></select>
            </div>
            <div class="input-group">
                <label for="y-axis">æ­¥é©Ÿ 3ï¼šé¸æ“‡ Y è»¸ (ç¸±è»¸)</label>
                <select id="y-axis"></select>
            </div>
            <div class="input-group">
                <label for="chart-type">æ­¥é©Ÿ 4ï¼šåœ–è¡¨é¡å‹</label>
                <select id="chart-type">
                    <option value="scatter">æŠ˜ç·šåœ– (Lines + Markers)</option>
                    <option value="bar">é•·æ¢åœ– (Bar Chart)</option>
                    <option value="markers">æ•£ä½ˆåœ– (Only Markers)</option>
                </select>
            </div>
            <div class="action-area full-width">
                <button id="btn-plot">ğŸš€ é–‹å§‹ç¹ªåœ–</button>
            </div>
        </div>
    </div>

    <div id="plot-area"></div>
</div>

<script>
    let csvData = []; 

    // 1. ç›£è½æª”æ¡ˆä¸Šå‚³
    document.getElementById('csv-file').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            header: true,
            dynamicTyping: true, // è‡ªå‹•è½‰æ›æ•¸å­—
            skipEmptyLines: true,
            complete: function(results) {
                csvData = results.data;
                const headers = results.meta.fields;
                
                if (headers && headers.length > 0) {
                    populateSelectors(headers);
                    // é¡¯ç¤ºæ§åˆ¶é … (ç§»é™¤ hidden classï¼Œä¸¦å°‡ display æ”¹ç‚º contents ä»¥é…åˆ grid)
                    const selectors = document.getElementById('column-selectors');
                    selectors.classList.remove('hidden');
                } else {
                    alert('ç„¡æ³•è®€å– CSV æ¨™é¡Œï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼ (UTF-8 ç·¨ç¢¼ä½³)ã€‚');
                }
            },
            error: function(err) {
                alert("è§£æå¤±æ•—ï¼š" + err.message);
            }
        });
    });

    // 2. å¡«å……é¸å–®
    function populateSelectors(headers) {
        const xSelect = document.getElementById('x-axis');
        const ySelect = document.getElementById('y-axis');
        
        xSelect.innerHTML = '';
        ySelect.innerHTML = '';

        headers.forEach(header => {
            xSelect.add(new Option(header, header));
            ySelect.add(new Option(header, header));
        });

        // æ™ºæ…§é é¸ï¼šå˜—è©¦å°‡ç¬¬äºŒå€‹æ¬„ä½è¨­ç‚º Y è»¸
        if (headers.length > 1) ySelect.selectedIndex = 1;
    }

    // 3. ç¹ªåœ–é‚è¼¯
    document.getElementById('btn-plot').addEventListener('click', function() {
        const xCol = document.getElementById('x-axis').value;
        const yCol = document.getElementById('y-axis').value;
        const type = document.getElementById('chart-type').value;

        if (!xCol || !yCol) {
            alert("è«‹é¸æ“‡ X è»¸å’Œ Y è»¸");
            return;
        }

        // --- é—œéµå„ªåŒ–ï¼šè³‡æ–™æ•´ç†èˆ‡æ’åº ---
        // å°‡ X å’Œ Y çµåˆæˆç‰©ä»¶é™£åˆ—ï¼Œä»¥ä¾¿é€²è¡Œæ’åº
        let plotData = csvData.map(row => ({
            x: row[xCol],
            y: row[yCol]
        })).filter(item => item.x != null && item.y != null); // éæ¿¾æ‰ç©ºå€¼

        // å¦‚æœæ˜¯æŠ˜ç·šåœ–ï¼Œé€šå¸¸éœ€è¦ä¾ç…§ X è»¸æ’åºï¼Œå¦å‰‡ç·šæ¢æœƒäº‚è·‘
        if (type === 'scatter' || type === 'lines') {
            plotData.sort((a, b) => {
                // å˜—è©¦è™•ç†æ—¥æœŸæˆ–æ•¸å­—æ’åº
                return a.x > b.x ? 1 : -1;
            });
        }

        // æ‹†å› X å’Œ Y é™£åˆ—
        const xData = plotData.map(d => d.x);
        const yData = plotData.map(d => d.y);
        // ----------------------------------

        // è¨­å®š Plotly åƒæ•¸
        let trace = {
            x: xData,
            y: yData,
            name: yCol
        };

        // æ ¹æ“šé¡å‹èª¿æ•´æ¨£å¼
        if (type === 'bar') {
            trace.type = 'bar';
        } else if (type === 'markers') {
            trace.mode = 'markers';
            trace.type = 'scatter';
            trace.marker = { size: 10, opacity: 0.7 };
        } else { // é è¨­ scatter (æŠ˜ç·šåœ–)
            trace.mode = 'lines+markers';
            trace.type = 'scatter';
            trace.line = { shape: 'linear' }; // å¯æ”¹ç‚º 'spline' è®Šå¹³æ»‘æ›²ç·š
        }

        const layout = {
            title: {
                text: `${yCol} vs ${xCol}`,
                font: { size: 24 }
            },
            xaxis: { title: xCol, automargin: true },
            yaxis: { title: yCol, automargin: true },
            margin: { t: 60, l: 60, r: 40, b: 60 },
            hovermode: 'closest',
            paper_bgcolor: "rgba(0,0,0,0)", // é€æ˜èƒŒæ™¯
            plot_bgcolor: "rgba(0,0,0,0)"
        };
        
        const config = {
            responsive: true,
            displayModeBar: true, // é¡¯ç¤ºå·¥å…·åˆ— (ä¸‹è¼‰åœ–ç‰‡ã€ç¸®æ”¾ç­‰)
            displaylogo: false
        };

        Plotly.newPlot('plot-area', [trace], layout, config);
    });
</script>

</body>
</html>
